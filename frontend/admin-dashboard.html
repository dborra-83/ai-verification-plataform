<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech AI - Configuracion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="bi bi-mortarboard me-2"></i><span id="platformName">EduTech AI</span></h1>
                <p>Plataforma Educativa Docente</p>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section-header"><i class="bi bi-shield-check me-2"></i>Deteccion de IA</div>
                <a href="index.html" class="nav-item"><i class="bi bi-speedometer2"></i>Dashboard</a>
                <a href="index.html#upload" class="nav-item"><i class="bi bi-cloud-upload"></i>Nuevo Analisis</a>
                <a href="index.html#history" class="nav-item"><i class="bi bi-clock-history"></i>Historial</a>
                <a href="index.html#analytics" class="nav-item"><i class="bi bi-graph-up"></i>Analytics y Reportes</a>
                <div class="nav-section-header"><i class="bi bi-file-earmark-text me-2"></i>Examenes con IA</div>
                <a href="exam-dashboard.html" class="nav-item"><i class="bi bi-speedometer2"></i>Dashboard</a>
                <a href="exam-generator.html" class="nav-item"><i class="bi bi-plus-circle"></i>Generador de Examenes</a>
                <a href="exam-history.html" class="nav-item"><i class="bi bi-journal-text"></i>Historial de Examenes</a>
                <div class="nav-section-header"><i class="bi bi-gear-wide-connected me-2"></i>Administracion</div>
                <a href="admin-dashboard.html" class="nav-item active"><i class="bi bi-sliders"></i>Configuracion</a>
                <div class="nav-section-header"><i class="bi bi-collection-play me-2"></i>Otras Demos</div>
                <a href="https://d2wi2vfruzr64e.cloudfront.net/" class="nav-item" target="_blank"><i class="bi bi-pc-display"></i>Entornos Virtuales<i class="bi bi-box-arrow-up-right ms-auto" style="font-size: 0.8rem; opacity: 0.7;"></i></a>
                <a href="https://d1btovt86fwovd.cloudfront.net/" class="nav-item" target="_blank"><i class="bi bi-exclamation-triangle"></i>Deteccion Temprana de Riesgo Academico<i class="bi bi-box-arrow-up-right ms-auto" style="font-size: 0.8rem; opacity: 0.7;"></i></a>
                <hr style="border-color: rgba(255,255,255,0.2); margin: 1rem 1.5rem;">
                <a href="#" class="nav-item" onclick="logout()"><i class="bi bi-box-arrow-right"></i>Cerrar Sesion</a>
            </div>
        </nav>
        <main class="main-content">
            <div class="topbar">
                <h2 id="pageTitle">Configuracion</h2>
                <div class="topbar-actions">
                    <span id="user-email" class="text-muted me-3"></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
                </div>
            </div>
            <div class="content-area">
                <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-panel" type="button" role="tab"><i class="bi bi-palette me-2"></i>Administracion General</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-panel" type="button" role="tab"><i class="bi bi-people me-2"></i>Control de Usuarios</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-panel" type="button" role="tab"><i class="bi bi-speedometer2 me-2"></i>Configuracion del Dashboard</button>
                    </li>
                </ul>
                <div class="tab-content" id="configTabContent">
                    <div class="tab-pane fade show active" id="general-panel" role="tabpanel">
                        <div class="row mb-4"><div class="col"><h4 class="mb-1"><i class="bi bi-palette me-2"></i>Administracion General</h4><p class="text-muted">Personalizacion de marca blanca y configuracion de interfaz</p></div></div>
                        <div class="card mb-4"><div class="card-header"><h5 class="mb-0"><i class="bi bi-building me-2"></i>Identidad de Marca</h5></div>
                            <div class="card-body"><div class="row g-3">
                                <div class="col-md-6"><label class="form-label">Nombre de la Plataforma</label><input type="text" class="form-control" id="platformNameInput" placeholder="EduTech AI"></div>
                                <div class="col-md-6"><label class="form-label">Subtitulo</label><input type="text" class="form-control" id="platformSubtitle" placeholder="Plataforma Educativa Docente"></div>
                                <div class="col-md-6"><label class="form-label">URL del Logo</label><input type="url" class="form-control" id="logoUrl" placeholder="https://ejemplo.com/logo.png"></div>
                                <div class="col-md-6"><label class="form-label">Email de Soporte</label><input type="email" class="form-control" id="supportEmail" placeholder="soporte@ejemplo.com"></div>
                            </div></div>
                        </div>
                        <div class="card mb-4"><div class="card-header"><h5 class="mb-0"><i class="bi bi-brush me-2"></i>Configuracion de Interfaz</h5></div>
                            <div class="card-body"><div class="row g-3">
                                <div class="col-md-4"><label class="form-label">Tema</label><select class="form-select" id="themeSelect"><option value="light">Claro</option><option value="dark">Oscuro</option><option value="auto">Automatico</option></select></div>
                                <div class="col-md-4"><label class="form-label">Color Principal</label><input type="color" class="form-control form-control-color w-100" id="primaryColor" value="#008FD0"></div>
                                <div class="col-md-4"><label class="form-label">Tamano de Fuente</label><select class="form-select" id="fontSizeSelect"><option value="small">Pequeno</option><option value="normal" selected>Normal</option><option value="large">Grande</option></select></div>
                            </div></div>
                        </div>
                        <div class="d-flex gap-2"><button class="btn btn-primary" onclick="saveGeneralConfig()"><i class="bi bi-save me-2"></i>Guardar Cambios</button><button class="btn btn-outline-secondary" onclick="resetGeneralConfig()"><i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar Valores</button></div>
                    </div>
                    <div class="tab-pane fade" id="users-panel" role="tabpanel">
                        <div class="row mb-4"><div class="col"><h4 class="mb-1"><i class="bi bi-people me-2"></i>Control de Usuarios</h4><p class="text-muted">Gestion de usuarios de la plataforma (Cognito)</p></div></div>
                        <div class="row mb-4">
                            <div class="col-md-3"><div class="card"><div class="card-body text-center"><h3 class="text-primary mb-1" id="totalUsersCount">-</h3><small class="text-muted">Total Usuarios</small></div></div></div>
                            <div class="col-md-3"><div class="card"><div class="card-body text-center"><h3 class="text-success mb-1" id="activeUsersCount">-</h3><small class="text-muted">Activos (30 dias)</small></div></div></div>
                            <div class="col-md-3"><div class="card"><div class="card-body text-center"><h3 class="text-info mb-1" id="newUsersCount">-</h3><small class="text-muted">Nuevos (este mes)</small></div></div></div>
                            <div class="col-md-3"><div class="card"><div class="card-body text-center"><h3 class="text-warning mb-1" id="disabledUsersCount">-</h3><small class="text-muted">Deshabilitados</small></div></div></div>
                        </div>
                        <div class="card mb-4"><div class="card-body"><div class="row g-3 align-items-end">
                            <div class="col-md-4"><label class="form-label">Buscar</label><div class="input-group"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" class="form-control" id="userSearchInput" placeholder="Buscar por email..." onkeyup="debounceUserSearch(this.value)"></div></div>
                            <div class="col-md-2"><label class="form-label">Estado</label><select class="form-select" id="userStatusFilter" onchange="applyUserFilters()"><option value="">Todos</option><option value="enabled">Habilitados</option><option value="disabled">Deshabilitados</option></select></div>
                            <div class="col-md-2"><label class="form-label">Rol</label><select class="form-select" id="userRoleFilter" onchange="applyUserFilters()"><option value="">Todos</option><option value="admin">Administrador</option><option value="teacher">Profesor</option></select></div>
                            <div class="col-md-4 text-end"><button class="btn btn-primary" onclick="UserManagementModule.showCreateUserModal()"><i class="bi bi-person-plus me-2"></i>Nuevo Usuario</button><button class="btn btn-outline-secondary ms-2" onclick="UserManagementModule.loadUsers()"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button></div>
                        </div></div></div>
                        <div class="alert alert-info mb-3" id="bulkActions" style="display: none;"><div class="d-flex justify-content-between align-items-center"><span id="selectedCount">0 usuario(s) seleccionado(s)</span><div><button class="btn btn-sm btn-success me-2" onclick="UserManagementModule.bulkUpdateStatus(Array.from(UserManagementModule.getSelectedUsers()), true)"><i class="bi bi-person-check me-1"></i>Habilitar</button><button class="btn btn-sm btn-warning" onclick="UserManagementModule.bulkUpdateStatus(Array.from(UserManagementModule.getSelectedUsers()), false)"><i class="bi bi-person-slash me-1"></i>Deshabilitar</button></div></div></div>
                        <div class="card"><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAll" onchange="UserManagementModule.toggleSelectAll()"></th><th>Email</th><th>Estado</th><th>Rol</th><th>Fecha Creacion</th><th>Ultimo Acceso</th><th>Acciones</th></tr></thead><tbody id="userTableBody"><tr><td colspan="7" class="text-center text-muted py-4"><i class="bi bi-people me-2"></i>Haz clic en "Actualizar" para cargar usuarios</td></tr></tbody></table></div><div id="userPagination" class="mt-3"></div></div></div>
                    </div>
                    <div class="tab-pane fade" id="dashboard-panel" role="tabpanel">
                        <div class="row mb-4"><div class="col"><h4 class="mb-1"><i class="bi bi-speedometer2 me-2"></i>Configuracion del Dashboard</h4><p class="text-muted">Personaliza la visualizacion y comportamiento del dashboard</p></div></div>
                        <div class="card mb-4"><div class="card-header"><h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Indicadores (KPIs)</h5></div><div class="card-body"><div class="row g-3">
                            <div class="col-md-4"><label class="form-label">Periodo de KPIs</label><select class="form-select" id="kpiPeriod"><option value="7">Ultimos 7 dias</option><option value="30" selected>Ultimos 30 dias</option><option value="90">Ultimos 90 dias</option></select></div>
                            <div class="col-md-4"><label class="form-label">Umbral Alto Riesgo IA (%)</label><input type="number" class="form-control" id="highRiskThreshold" min="0" max="100" value="70"></div>
                            <div class="col-md-4"><label class="form-label">Elementos por Pagina</label><select class="form-select" id="itemsPerPage"><option value="10" selected>10 elementos</option><option value="20">20 elementos</option><option value="50">50 elementos</option></select></div>
                        </div></div></div>
                        <div class="card mb-4"><div class="card-header"><h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Actualizacion Automatica</h5></div><div class="card-body"><div class="row g-3">
                            <div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="autoRefresh" checked><label class="form-check-label" for="autoRefresh">Actualizacion automatica</label></div></div>
                            <div class="col-md-4"><label class="form-label">Intervalo</label><select class="form-select" id="refreshInterval"><option value="30">30 segundos</option><option value="60" selected>1 minuto</option><option value="300">5 minutos</option></select></div>
                            <div class="col-md-4"><div class="form-check form-switch mt-4"><input class="form-check-input" type="checkbox" id="showNotifications" checked><label class="form-check-label" for="showNotifications">Mostrar notificaciones</label></div></div>
                        </div></div></div>
                        <div class="d-flex gap-2"><button class="btn btn-primary" onclick="saveDashboardConfig()"><i class="bi bi-save me-2"></i>Guardar Cambios</button><button class="btn btn-outline-secondary" onclick="resetDashboardConfig()"><i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar Valores</button></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="modal fade" id="createUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Crear Nuevo Usuario</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><form id="createUserForm">
            <div class="mb-3"><label class="form-label">Email *</label><input type="email" class="form-control" id="newUserEmail" required></div>
            <div class="mb-3"><label class="form-label">Contrasena Temporal *</label><input type="password" class="form-control" id="newUserPassword" required minlength="8"><small class="text-muted">Minimo 8 caracteres</small></div>
            <div class="mb-3"><label class="form-label">Rol</label><select class="form-select" id="newUserRole"><option value="teacher">Profesor</option><option value="admin">Administrador</option></select></div>
        </form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="UserManagementModule.createUser()"><i class="bi bi-person-plus me-1"></i>Crear Usuario</button></div>
    </div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Editar Usuario</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><form id="editUserForm"><input type="hidden" id="editUserUsername">
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="editUserEmail" readonly></div>
            <div class="mb-3"><label class="form-label">Rol</label><select class="form-select" id="editUserRole"><option value="teacher">Profesor</option><option value="admin">Administrador</option></select></div>
            <div class="mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="editUserEnabled"><label class="form-check-label" for="editUserEnabled">Usuario Habilitado</label></div></div>
        </form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="UserManagementModule.saveUserChanges()"><i class="bi bi-save me-1"></i>Guardar Cambios</button></div>
    </div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/platform-config.js"></script>
    <script src="js/user-management.js"></script>
    <script src="js/admin-dashboard.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication using ai_verification_auth (same as other pages)
            const authData = localStorage.getItem('ai_verification_auth');
            if (!authData) { 
                window.location.href = 'login.html'; 
                return; 
            }
            try {
                const auth = JSON.parse(authData);
                if (!auth.accessToken) {
                    window.location.href = 'login.html';
                    return;
                }
                // Display user email
                if (auth.email) {
                    document.getElementById('user-email').textContent = auth.email;
                }
            } catch (e) {
                console.error('Error parsing auth data:', e);
                window.location.href = 'login.html';
                return;
            }
            
            if (typeof PlatformConfig !== 'undefined') PlatformConfig.applyConfig();
                        loadGeneralConfigValues();
            loadDashboardConfigValues();
        });
        
        function logout() { 
            localStorage.removeItem('ai_verification_auth');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html'; 
        }
        
        let searchTimeout;
        function debounceUserSearch(value) { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => applyUserFilters(), 300); }
        function applyUserFilters() {
            if (typeof UserManagementModule !== 'undefined') {
                const search = document.getElementById('userSearchInput')?.value || '';
                const status = document.getElementById('userStatusFilter')?.value || '';
                const role = document.getElementById('userRoleFilter')?.value || '';
                UserManagementModule.filterUsers(search, status, role);
            }
        }
        function loadGeneralConfigValues() {
            const config = JSON.parse(localStorage.getItem('platformConfig') || '{}');
            document.getElementById('platformNameInput').value = config.platformName || 'EduTech AI';
            document.getElementById('platformSubtitle').value = config.subtitle || 'Plataforma Educativa Docente';
            document.getElementById('logoUrl').value = config.logoUrl || '';
            document.getElementById('supportEmail').value = config.supportEmail || '';
            document.getElementById('themeSelect').value = config.theme || 'light';
            document.getElementById('primaryColor').value = config.primaryColor || '#008FD0';
            document.getElementById('fontSizeSelect').value = config.fontSize || 'normal';
        }
        function saveGeneralConfig() {
            const config = { platformName: document.getElementById('platformNameInput').value, subtitle: document.getElementById('platformSubtitle').value, logoUrl: document.getElementById('logoUrl').value, supportEmail: document.getElementById('supportEmail').value, theme: document.getElementById('themeSelect').value, primaryColor: document.getElementById('primaryColor').value, fontSize: document.getElementById('fontSizeSelect').value };
            localStorage.setItem('platformConfig', JSON.stringify(config));
            if (typeof PlatformConfig !== 'undefined') PlatformConfig.applyConfig();
            Swal.fire({ icon: 'success', title: 'Configuracion Guardada', timer: 2000, showConfirmButton: false });
        }
        function resetGeneralConfig() { localStorage.removeItem('platformConfig'); loadGeneralConfigValues(); if (typeof PlatformConfig !== 'undefined') PlatformConfig.applyConfig(); Swal.fire({ icon: 'info', title: 'Valores Restaurados', timer: 2000, showConfirmButton: false }); }
        function loadDashboardConfigValues() {
            const config = JSON.parse(localStorage.getItem('dashboardConfig') || '{}');
            document.getElementById('kpiPeriod').value = config.kpiPeriod || '30';
            document.getElementById('highRiskThreshold').value = config.highRiskThreshold || '70';
            document.getElementById('itemsPerPage').value = config.itemsPerPage || '10';
            document.getElementById('autoRefresh').checked = config.autoRefresh !== false;
            document.getElementById('refreshInterval').value = config.refreshInterval || '60';
            document.getElementById('showNotifications').checked = config.showNotifications !== false;
        }
        function saveDashboardConfig() {
            const config = { kpiPeriod: document.getElementById('kpiPeriod').value, highRiskThreshold: document.getElementById('highRiskThreshold').value, itemsPerPage: document.getElementById('itemsPerPage').value, autoRefresh: document.getElementById('autoRefresh').checked, refreshInterval: document.getElementById('refreshInterval').value, showNotifications: document.getElementById('showNotifications').checked };
            localStorage.setItem('dashboardConfig', JSON.stringify(config));
            Swal.fire({ icon: 'success', title: 'Configuracion del Dashboard Guardada', timer: 2000, showConfirmButton: false });
        }
        function resetDashboardConfig() { localStorage.removeItem('dashboardConfig'); loadDashboardConfigValues(); Swal.fire({ icon: 'info', title: 'Valores Restaurados', timer: 2000, showConfirmButton: false }); }
    </script>
</body>
</html>
